{% extends 'base.html' %}
<!DOCTYPE html>
<html lang="zh-Hant-TW">

<head>
    {% block head %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.3/css/all.css" integrity="sha384-SZXxX4whJ79/gErwcOYf+zWLeJdY/qpuqC4cAa9rOGUstPomtqpuNWT9wdPEn2fk" crossorigin="anonymous">
    <style>
        body{
          width: 100%;
          height: 100%;
          overflow-x: hidden;
          background: url("/static/images/bg2.jpg")!important;
          background-repeat: no-repeat;
          background-position: center bottom;
        }
    </style>
    {% endblock %}
</head>

<body>
    {% block body %}
    <div id="vue_app" class="cont flex-column">
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid" style="margin-left: 3.2px;">
                <a class="navbar-brand logo1" href="/v_search/land_dev/"></a>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item bi ddd"><a href="/v_search/land_dev/" class="bia">土地開發</a></li>
                    </ol>
                </nav>
            </div>
            <div class="d-flex5">
                <a href="#" type="button" class="btn dropdown-toggle w-150" data-bs-toggle="dropdown" data-bs-target="usermenu" aria-expanded="false">
                    {% if user.first_name == '' %}
                    {{ user.username }}
                    {% else %}
                    {{ user.first_name }}
                    {% endif %}
                    <svg  class="svg5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M4.427 7.427l3.396 3.396a.25.25 0 00.354 0l3.396-3.396A.25.25 0 0011.396 7H4.604a.25.25 0 00-.177.427z"></path></svg>
                </a>
                <ul id="usermenu" class="dropdown-menu dropdown-menu-end">
                    <li class="">
                        <a href="/v_search/member_pw/" class="btn dropdown-item">
                            變更密碼
                        </a>
                    </li>
                    <li class="tmp">
                        <a href="/v_search/member_aclist/" class="btn dropdown-item">
                            帳號管理
                        </a>
                    </li>
                    <li>
                        <a href="#" id="buttonForLogout" class="btn dropdown-item" @click="logout()">
                            登出
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <div class="container wrap">
            <nav aria-label="breadcrumb" class="bb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/v_search/land_dev/">首頁</a></li>
                    <li class="breadcrumb-item active"><a href="/v_search/member_aclist/">帳號管理</a></li>
                    <li class="breadcrumb-item active">新增帳號</li>
                </ol>
            </nav>
            <div class="form1 row">
                <h3 class="text-center h3bottom">新增帳號</h3>
                <div class="width50">
                    <div class="row">
                        <div class="px-2 col">
                            <label>權限</label>
                            <div class="input-group mb-3">
                                <select class="form-select" v-model="dataForm.role">
                                    <option>請選擇權限</option>
                                    <option value="0">主管</option>
                                    <option value="1">專員</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="px-2 col">
                            <label>帳號</label>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" placeholder="帳號" v-model="dataForm.account">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="px-2 col">
                            <label>密碼</label>
                            <div class="input-group mb-3">
                                <input type="password" class="form-control" placeholder="密碼" v-password v-model="dataForm.password">
                            </div>
                        </div>
                        <div class="px-2 col">
                            <label>確認密碼</label>
                            <div class="input-group mb-3">
                                <input type="password" class="form-control" placeholder="確認密碼" v-password v-model="dataForm.password2">
                            </div>
                        </div>
                    </div>
                    <hr class="hr"/>
                    <div class="row">
                        <div class="px-2 col">
                            <label>名稱</label>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" placeholder="名稱" v-model="dataForm.name">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="px-2 col">
                            <label>電話</label>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" placeholder="電話" v-model="dataForm.phone">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="px-2 col">
                            <label>開放地區</label>
                            <div class="input-group mb-3">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">開放地區</button>
                                <ul class="dropdown-menu" style="max-height: 600px; overflow: hidden overlay;">
                                    <li v-for="(city, cityKey) in cityList" @click.stop>
                                        <div class="dropdown-item">
                                            <input :id="'allowed' + cityKey" type="checkbox" v-model="dataForm.open_area[cityKey].checked" @click="getArea(cityKey)">
                                            <label :for="'allowed' + cityKey" class="ms-2 w-100" role="button">(( city ))</label>
                                        </div>
                                        <div class="ms-4" v-if="dataForm.open_area[cityKey].checked">
                                            <div class="dropdown-item">
                                                <input id="allowedAllArea" type="checkbox" v-model="dataForm.open_area[cityKey].all">
                                                <label for="allowedAllArea" class="ms-2 w-100" role="button">全區</label>
                                            </div>
                                            <div class="dropdown-item" v-for="(area, areaKey) in areaList[cityKey]">
                                                <input :id="'allowed' + areaKey" type="checkbox" v-model="dataForm.open_area[cityKey][areaKey]">
                                                <label :for="'allowed' + areaKey" class="ms-2 w-100" role="button">(( area ))</label>
                                            </div>
                                            <hr>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="d-inline-block width80">
                        <button class="btn btn-primary btn003 width102 btnaa" @click="addAccount()">確認</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endblock %}

    {% block script %}
    <script>
        const baseapp = Vue.createApp({
            delimiters: ['((', '))'],
            data() {
                return {
                    cityList: { "A": "臺北市", "C": "基隆市", "F": "新北市", "H": "桃園市", "O": "新竹市", "J": "新竹縣", "B": "臺中市", "K": "苗栗縣", "N": "彰化縣", "M": "南投縣", "P": "雲林縣", "D": "臺南市", "E": "高雄市", "I": "嘉義市", "Q": "嘉義縣", "T": "屏東縣", "G": "宜蘭縣", "U": "花蓮縣", "V": "臺東縣",/* "X": "澎湖縣", "W": "金門縣", "Z": "連江縣" */},
                    areaList: {},
                    dataForm:{
                        account: "",
                        password: "",
                        password2: "",
                        name: "",
                        phone: "",
                        open_area: {},
                        role: 0
                    }
                }
            },
            methods: {
                logout(){
                    new HTTPreq("/v_search/logout/", "fd").geta().then(rcv => {
                        var res = supfnc.toJSON(rcv.result);
                        if(res.status == "OK"){
                            window.location.href = "/";
                        }
                    });
                },
                getArea(city){
                    var T = this;
                    if(!city || this.areaList[city]) return;
                    new HTTPreq("/v_search/get_area/?city=" + city).geta().then((rcv) => {
                        var res = supfnc.toJSON(rcv.result), data = {};
                        for(var i in res){
                            data[city + "_" + res[i].area_code] = res[i].area_name;
                        }
                        T.areaList[city] = data;
                    });
                },
                addAccount(){
                    var T = this;
                    var dataForm = this.dataForm.duplicate();
                    dataForm.delete = false;
                    dataForm.open_area = dataForm.open_area.reduce((a, e, i) => {
                        if(e.all){
                            a.push(`${ i };${ T.cityList[i] }`);
                        }
                        else{
                            for(var area in e){
                                if(["all", "checked"].includes(area)) continue;
                                if(e[area]) a.push(`${ area };${ T.cityList[i] };${ T.areaList[i][area] }`);
                            }
                        }
                        return a;
                    }, []);
                    new HTTPreq("/users/add_user/", "fd").posta(dataForm).then(rcv => {
                        var res = supfnc.toJSON(rcv.result);
                        Swal.fire(res.msg, "", "success");
                    });
                },
            },
            mounted(){},
            created(){
                this.dataForm.open_area = this.cityList.reduce((a, e, i) => {
                    a[i] = {};
                    return a;
                }, {});
            },
            updated(){},
            beforeUpdate(){},
        });
    </script>
    {% endblock %}
</body>

</html>